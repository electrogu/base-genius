name: Weekly Quiz Generation

on:
  # Run every Sunday at midnight UTC
  schedule:
    - cron: '0 0 * * 0'
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  generate-questions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Generate quiz questions
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NEYNAR_API_KEY: ${{ secrets.NEYNAR_API_KEY }}
        run: |
          python scripts/generate_weekly_questions.py
      
      - name: Get current week number
        id: week
        run: |
          WEEK_NUMBER=$(jq -r '.weekNumber' app/data/quiz-questions.json)
          echo "week_number=$WEEK_NUMBER" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat: Week ${{ steps.week.outputs.week_number }} quiz questions'
          branch: automated-quiz-week-${{ steps.week.outputs.week_number }}
          delete-branch: true
          title: 'ğŸ“ Week ${{ steps.week.outputs.week_number }} Quiz Questions'
          body: |
            ## ğŸ¯ Automated Quiz Generation
            
            This PR contains **50 new quiz questions** for Week ${{ steps.week.outputs.week_number }}.
            
            ### ğŸ“Š Generated from:
            - Source: Jesse Pollak's latest Farcaster posts
            - AI: Google Gemini 1.5 Flash
            - Date: ${{ github.run_id }}
            
            ### âœ… Review Checklist
            - [ ] Questions are accurate and based on real events
            - [ ] All 50 questions present
            - [ ] Difficulty mix is appropriate
            - [ ] Sources are referenced
            - [ ] No duplicates from previous weeks
            
            ### ğŸš€ Next Steps
            1. Review the questions below
            2. Edit any questions if needed (directly in this PR)
            3. Merge when approved
            4. Vercel will auto-deploy to production
            
            ---
            
            **Generated automatically by GitHub Actions** ğŸ¤–
          labels: |
            automated
            quiz-questions
          reviewers: |
            ${{ github.repository_owner }}
